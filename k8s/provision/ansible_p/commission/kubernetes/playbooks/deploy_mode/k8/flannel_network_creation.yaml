# This playbook create flannel network.
---

- hosts: "{{ host_name }}"
  become: yes
  become_user: root
  vars:
    - VNI: "{{ vni }}"
  tasks:
      - name: Ansible create flannel network file
        copy:
         dest: "/home/{{ networkName }}_file.yaml"
         content: |
           apiVersion: "kubernetes.com/v1"
           kind: Network
           metadata:
            name: {{ networkName }}
           plugin: flannel
           args: '[
             {
                "delegate": {
                "isDefaultGateway":true
              }
             }
           ]'
        when: VNI == "1" 

      - name: Ansible create flannel network file
        copy:
         dest: "/home/{{ networkName }}_file.yaml"
         content: |
           apiVersion: "kubernetes.com/v1"
           kind: Network
           metadata:
            name: {{ networkName }}
           plugin: flannel
           args: '[
            {
              "type": "flannel",
              "master": "flannel.{{ vni }}",
              "subnetFile": "/run/flannel/{{ vni }}.env",
              "delegate": {
                "bridge": "cbr{{vniTemp}}"
            }
            }
           ]'
        when: VNI > "1" 

      - name: creating flannel network
        command: "{{ item }}"
        with_items:
            - kubectl create -f /home/{{networkName}}_file.yaml
        ignore_errors: true 
